# UWB-PDoA物联网关网络侧API

| 版本  |   日期   |       备注        |
| :---: | :------: | :---------------: |
| 1.0.0 | 20240805 | PDoA网关网络侧API |

## 概述

网络侧默认使用UDP传输（串口转UDP）推向本地边缘计算中心进行核心调度（称为定位核心网）。

> 1.若PDoA作为模块存在，根据当前实现的硬件架构，虽然外部主控和模组独立工作，但存在双方数据交互，这些信息的交互主要由通过UART媒介进行（在UART交互前进行IO唤醒）
>
> 2.通信方式：UART；通信速率：115200；数据位：8；停止位：1；奇偶校验：无；数据流控：无
>
> ![img](./UWB-PDoA物联网关网络侧API.assets/wps1.png)
>
> 3.外部主控指MTK7688等网络模块，具备将串口数据转为网络数据；
>
> 4.吾控模组指支持标准Fira的模组；

## 协议帧格式说明

|   字节0    |     字节1     |     字节2     | 字节3~字节n |
| :--------: | :-----------: | :-----------: | :---------: |
| 数据包类型 | 有效载荷长度1 | 有效载荷长度2 |  有效载荷   |

**（字节0）数据包类型**：

00：通知消息；

01：吾控模组UCI消息；

02：终端手环UCI消息；

03：状态信息获取消息；

f0：心跳包消息；

f1：UWB固件升级文件；（暂不支持）

ff：控制指令消息。

**（字节1）有效载荷长度1、（字节2）有效载荷长度2**：按照大端模式组合长度，表示字节3到字节n的总长度。

**（字节3~字节n）有效载荷：**标准UCI消息。

> 发送：ff 00 01 01 （数据包类型为控制指令消息，有效载荷长度为1个字节，有效载荷为01）
>
> 回复：00 00 02 ff 00 （数据包类型为通知消息，有效载荷长度为2个字节，有效载荷为ff 00）
>
> 发送：01 00 09 21 00 00 05 0F A6 44 BE 00（数据包类型为吾控模组UCI消息，有效载荷长度为9个字节，有效载荷参阅Fira标准协议文档）
>
> ......
>

## 通知消息

通知消息是外部主控对模组发起通信的回复，有效载荷长度根据实际情况处理。

| 有效载荷1 |     有效载荷2      |      有效载荷3~有效载荷n       |    发起方向    |      备注      |
| :-------: | :----------------: | :----------------------------: | :------------: | :------------: |
|   0xff    | 0x01：控制消息类型 | 0x00：设置成功，0x01：设置失败 | 模组->外部主控 |  设置成功与否  |
|   0x01    |        预留        |   0x01：未找到相关数据包类型   | 模组->外部主控 | 数据包正确与否 |
| 0x04-0xfe |        预留        |              预留              | 模组->外部主控 |      预留      |

## 状态信息获取消息

状态信息获取消息是外部主控对模组发起通信，有效载荷长度根据实际情况处理。

| 有效载荷1 | 有效载荷2~有效载荷n |    发起方向    |        备注         |
| :-------: | :-----------------: | :------------: | :-----------------: |
|   0x01    |         空          | 外部主控->模组 |   获取主板MAC地址   |
|   0x02    |         空          | 外部主控->模组 | 获取主板UCI通信状态 |
|   0x03    |         空          | 外部主控->模组 | 获取主板UWB电源状态 |
| 0x04-0xff |        预留         | 外部主控->模组 |        预留         |

## 控制指令类消息

控制指令类消息是外部主控对模组发起通信，有效载荷长度根据实际情况处理。

| 有效载荷1 |                 有效载荷2~有效载荷n                  |    发起方向    |    备注     |
| :-------: | :--------------------------------------------------: | :------------: | :---------: |
|   0x01    |         0x01：允许UCI消息；0x00：禁止UCI消息         | 外部主控->模组 | 允许UCI消息 |
|   0x02    |                          空                          | 外部主控->模组 | 开启UWB电源 |
|   0x03    |                          空                          | 外部主控->模组 | 硬件复位UWB |
|   0x04    |                          空                          | 外部主控->模组 | UCI复位UWB  |
|   0x05    | 0x01：UWB进入固件下载模式；0x00：UWB退出固件下载模式 | 外部主控->模组 | UWB固件下载 |
| 0x06-0xff |                         预留                         | 外部主控->模组 |    预留     |

## ToF协议实例

```
外部主控发送：FF 00 02 01 01
模组回复：00 00 03 FF 01 00
外部主控发送：01 00 09 21 00 00 05 0F A6 44 BE 00
模组回复：01 00 0F 41 00 00 01 00 61 02 00 06 0F A6 44 BE 00 00
外部主控发送：01 00 B7 21 03 00 B3 0F A6 44 BE 25 11 01 00 00 01 00 32 02 06 00 01 01 01 03 01 00 12 01 03 2E 01 01 02 01 00 09 04 C8 00 00 00 1B 01 19 08 02 00 10 04 01 09 14 01 09 1F 01 00 17 01 01 15 01 02 29 01 01 16 01 00 35 01 01 2A 02 0A 00 2B 04 00 00 00 00 23 01 00 24 01 00 0B 01 00 26 01 00 06 02 A2 AA 05 01 01 07 02 A1 AA 27 02 F4 3C 28 06 6C 9D E6 8A A6 79 F0 08 F4 3C 79 A6 8A E6 9D 6C F1 04 00 00 00 00 F2 04 9E C7 1F 53 F3 10 CD 1C BF 4E 20 29 0B 66 2E 86 6F FB 18 46 32 73 F4 04 8F 25 FC 40 F5 10 EF 3C E1 E4 F8 7E D0 6E 76 11 5D 0A 8C 4E 47 57 E0 01 40
模组回复：01 00 10 61 02 00 06 0F A6 44 BE 03 00 41 03 00 02 00 00
外部主控发送：02 00 0F 3D FA D3 B0 F6 35 21 00 00 05 0F A6 44 BE 00
模组回复：02 00 15 3D FA D3 B0 F6 35 41 00 00 01 00 61 02 00 06 0F A6 44 BE 00 00
外部主控发送：02 00 C6 3D FA D3 B0 F6 35 21 03 00 BC 0F A6 44 BE 28 11 01 01 00 01 01 32 02 06 00 01 01 01 03 01 00 0C 01 02 12 01 03 2E 01 01 02 01 00 2C 01 00 2D 01 00 09 04 C8 00 00 00 1B 01 19 08 02 00 10 04 01 09 14 01 09 1F 01 00 17 01 01 15 01 02 29 01 01 16 01 00 35 01 01 2A 02 0A 00 2B 04 00 00 00 00 23 01 00 24 01 00 0B 01 00 26 01 00 06 02 A1 AA 05 01 01 07 02 A2 AA 27 02 F4 3C 28 06 6C 9D E6 8A A6 79 F0 08 F4 3C 79 A6 8A E6 9D 6C F1 04 00 00 00 00 F2 04 9E C7 1F 53 F3 10 CD 1C BF 4E 20 29 0B 66 2E 86 6F FB 18 46 32 73 F4 04 8F 25 FC 40 F5 10 EF 3C E1 E4 F8 7E D0 6E 76 11 5D 0A 8C 4E 47 57 E0 01 40
模组回复：02 00 16 3D FA D3 B0 F6 35 61 02 00 06 0F A6 44 BE 03 00 41 03 00 02 00 00
外部主控发送：02 00 0E 3D FA D3 B0 F6 35 22 00 00 04 0F A6 44 BE
模组回复：02 00 07 3D FA D3 B0 F6 35 00
外部主控发送：01 00 08 22 00 00 04 0F A6 44 BE
模组回复：01 00 3C 62 00 00 38 00 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 21 00 FF FF 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00
模组回复：01 00 3C 62 00 00 38 01 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 00 00 57 00 46 09 64 B8 12 64 00 00 00 00 00 00 00 15 08 EB 42 DF E9 35 C2 26 13 90 C2
模组回复：01 00 3C 62 00 00 38 02 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 00 00 57 00 73 09 63 B5 12 63 00 00 00 00 00 00 00 1B C4 EB 42 9B 37 39 C2 4E 28 8F C2
模组回复：01 00 3C 62 00 00 38 03 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 00 00 58 00 00 2D 02 11 F0 02 00 00 00 00 00 00 00 C6 93 C9 C0 4B 47 23 C3 E9 93 29 43
模组回复：01 00 3C 62 00 00 38 04 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 00 00 58 00 00 2D 04 6F F0 04 00 00 00 00 00 00 00 CA 37 79 C0 48 B5 26 C3 27 9A 2A 43
模组回复：01 00 3C 62 00 00 38 05 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 00 00 58 00 18 09 02 6F 12 02 00 00 00 00 00 00 00 A1 07 E8 42 B1 CE 33 C2 48 20 8E C2
模组回复：01 00 3C 62 00 00 38 06 00 00 00 0F A6 44 BE 00 C8 00 00 00 01 00 00 00 00 00 00 00 00 00 00 01 A1 AA 00 00 FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
```

